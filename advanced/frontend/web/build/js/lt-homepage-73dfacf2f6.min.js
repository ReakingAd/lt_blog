/* Build by Ltvieri 2017/03/11 18:42:30 */
(function(){"use strict";var t=this,e=t.jQuery;"undefined"==typeof t.blog&&(t.blog={}),t.blog.homepage={message:{latestTo:""},init:function(){this.showBtns(),this.getKeywords(),this.getPm2_5(),this.getNewarticle(),this.initBtnLoading(),this.bindingBtnGetMore()},showBtns:function(){Pubsub.listen("articleLoaded",function(){e(".btn-container").removeClass("lt-hide"),e("footer").show()})},getPm2_5:function(){e.ajax({url:"../post/aqi",type:"get",dataType:"json",cache:!0,success:function(t){var a;t&&t.aqi_pm25?(a=t.aqi_pm25,e(".pm2_5").html(a)):console.warn("获取pm2.5数据出错。")}})},getNewarticle:function(){var t=this;e.get("/post/get-article-new?range=1to3").done(function(e){if("string"!=typeof e)return console.warn("获取文章失败");try{e=JSON.parse(e)}catch(t){return console.log("数据格式错误"+t)}if(e.status&&"error"===e.status)return console.log(e.msg);if(e.status&&"success"===e.status){var a=e.msg;t._filloutMoreArticle(a)}})},_filloutMoreArticle:function(t){for(var a=e(".article-container"),i="",n='<i class = "draft-label">[草稿]</i>',s=0,r=t.length;s<r;s++)"2"!==t[s].status&&(n=""),i+='\t\t\t\t\t<article class="panel panel-default" data-create-time="'+t[s].create_time+'">\t\t\t\t\t\t<div class="panel-heading post-head">\t\t\t\t\t\t\t'+this._formatCreatetime(t[s].update_time)+'\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="panel-body post-content">\t\t\t\t\t\t\t<h3 class="post-head">'+t[s].title+n+"</h3>\t\t\t\t\t\t\t"+this.getFirstPara(t[s].content)+'\t\t\t\t\t\t\t<a class="pull-right" href="/article/'+t[s].id+"/"+t[s].title+'" title="'+t[s].title+'"> >>>查看详情</a>\t\t\t\t\t\t</div>\t\t\t\t\t</article>\t\t\t\t\t';a.append(i),Pubsub.trigger("articleLoaded"),this._enableLoading("off")},_formatCreatetime:function(t){if("string"!=typeof t)return t;var e=t.split(" ")[0];return e},getFirstPara:function(t){if("string"!=typeof t)return"";var e=/<p>[\s\S]*?<\/p>/g,a=t.match(e),i=a[0];return i},getKeywords:function(){var t=this;e.get("/post/get-keywords").done(function(e){var a=JSON.parse(e);t._showKeyword(a)})},_showKeyword:function(t){if("string"!=typeof t)return t;for(var a=t.split(","),i=e(".tags-container"),n=0;n<a.length;n++)i.tags({content:a[n],canRemove:"false"});this._showKeywordPage()},_showKeywordPage:function(){var t=this;e(".tags-container").on("click",".tag-container",function(){var a=e(this).find(".lt-tag").text();t._getArticleByTag(a)})},_getArticleByTag:function(t){var a=this;e.get("/post/get-article-by-tag?tag="+t).done(function(e){if(e=JSON.parse(e),e&&"fundefined"!=typeof e.msg&&"error"!==e.msg){var i=e.msg;a._filloutAritcleByTag(i,t)}else console.log("获取文章失败")})},_filloutAritcleByTag:function(t,a){for(var i="",n=0,s=t.length;n<s;n++)i+='\t\t\t\t\t<li>\t\t\t\t\t\t<a href="'+t[n].id+"/article/"+t[n].title+'/" title="'+t[n].title+'">'+t[n].title+'</a>\t\t\t\t\t\t<span class="pv pull-right">'+this._formatCreatetime(t[n].create_time)+"</span>\t\t\t\t\t</li>";var r=e(".tag-article-container");if(1===r.length){var o=e(".tag-article");o.html(""),o.append(i),e(".tag-name").text(a)}else{var l='\t\t\t\t\t<div class="panel panel-default tag-article-container">\t\t\t\t\t\t<div class="panel-heading">\t\t\t\t\t\t\t分类文章 : <span class="tag-name">'+(a||"")+'<span>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="panel-body">\t\t\t\t\t\t\t<ul class="tag-article">'+i+"</ul>\t\t\t\t\t\t</div>\t\t\t\t\t</div>",c=e("main.list-container");c.prepend(l)}},initBtnLoading:function(){var t={lines:9,length:7,width:3,radius:5,scale:.5,corners:1,color:"#000",opacity:.25,rotate:0,direction:1,speed:1,trail:100,fps:20,zIndex:2e9,className:"spinner",top:"50%",left:"50%",shadow:!1,hwaccel:!1,position:"absolute"},e=document.getElementsByClassName("btn-loading")[0];new Spinner(t).spin(e)},bindingBtnGetMore:function(){var t=this;e(".btn-getMore").on("click",function(){t._enableLoading("on");var a=e("article").last().data("create-time");e.get("/post/get-article-new?timeFlag="+a+"&range=1to3").done(function(e){try{e=JSON.parse(e)}catch(t){return console.log("数据格式错误"+t)}if(e.status&&"error"===e.status)return console.log(e.msg);if(e.status&&"success"===e.status){var a=e.msg;t._filloutMoreArticle(a)}})})},_enableLoading:function(t){if("string"==typeof t){var a=e(".btn-getMore");"on"===t?(a.addClass("lt-hide"),a.attr("disabled","disabled"),a.siblings(".btn-loading").removeClass("lt-hide")):"off"===t&&(a.removeAttr("disabled"),a.removeClass("lt-hide"),a.siblings(".btn-loading").addClass("lt-hide"))}}}}).call(this),$(document).ready(function(){"use strict";var t=window;t.jQuery;t.blog.homepage.init()});